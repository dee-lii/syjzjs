<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VPS å‰©ä½™ä»·å€¼è®¡ç®—å™¨</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 600px;
      width: 100%;
      padding: 40px;
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
      text-align: center;
    }

    .subtitle {
      color: #666;
      text-align: center;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
      font-size: 14px;
    }

    input[type="number"],
    input[type="date"],
    select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    input[type="number"]:focus,
    input[type="date"]:focus,
    select:focus {
      outline: none;
      border-color: #667eea;
    }

    .cycle-options {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .cycle-option {
      position: relative;
    }

    .cycle-option input[type="radio"] {
      position: absolute;
      opacity: 0;
    }

    .cycle-option label {
      display: block;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      margin: 0;
    }

    .cycle-option input[type="radio"]:checked + label {
      border-color: #667eea;
      background: #f0f4ff;
      color: #667eea;
      font-weight: 600;
    }

    button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      margin-top: 10px;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    .result {
      margin-top: 30px;
      padding: 24px;
      background: #f8f9fa;
      border-radius: 12px;
      display: none;
    }

    .result.show {
      display: block;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .result-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #e0e0e0;
    }

    .result-item:last-child {
      border-bottom: none;
    }

    .result-label {
      color: #666;
      font-size: 14px;
    }

    .result-value {
      color: #333;
      font-size: 18px;
      font-weight: 600;
    }

    .result-value.highlight {
      color: #667eea;
      font-size: 24px;
    }

    .progress-bar {
      width: 100%;
      height: 24px;
      background: #e0e0e0;
      border-radius: 12px;
      overflow: hidden;
      margin-top: 8px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.5s ease-out;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      font-weight: 600;
    }

    .error {
      background: #fee;
      color: #c33;
      padding: 12px;
      border-radius: 8px;
      margin-top: 10px;
      display: none;
      font-size: 14px;
    }

    .error.show {
      display: block;
    }

    .share-section {
      margin-top: 20px;
      padding: 20px;
      background: #f0f4ff;
      border-radius: 12px;
      display: none;
    }

    .share-section.show {
      display: block;
      animation: slideIn 0.3s ease-out;
    }

    .share-btn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
      margin-top: 10px;
    }

    .share-btn:hover {
      transform: translateY(-1px);
    }

    .badge-preview {
      margin-top: 15px;
      text-align: center;
    }

    .badge-preview img {
      max-width: 100%;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .share-link {
      margin-top: 15px;
    }

    .share-link label {
      display: block;
      margin-bottom: 8px;
      font-size: 13px;
      color: #666;
    }

    .share-link input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 12px;
      font-family: monospace;
      background: white;
    }

    .share-link input:focus {
      outline: none;
      border-color: #667eea;
    }

    .copy-btn {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .copy-btn:hover {
      background: #667eea;
      color: white;
    }

    .copy-btn.copied {
      background: #44cc11;
      border-color: #44cc11;
      color: white;
    }

    .currency-converter {
      margin-top: 15px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      display: none;
    }

    .currency-converter.show {
      display: block;
    }

    .currency-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .currency-row select {
      flex: 1;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }

    .currency-value {
      flex: 2;
      padding: 8px;
      background: #f8f9fa;
      border-radius: 6px;
      font-weight: 600;
      color: #333;
      text-align: right;
    }

    .exchange-rate-badge {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      padding: 12px 16px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      font-size: 12px;
      z-index: 1000;
      min-width: 200px;
      display: none;
    }

    .exchange-rate-badge.show {
      display: block;
      animation: slideInRight 0.3s ease-out;
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .exchange-rate-badge .title {
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .exchange-rate-badge .loading {
      color: #999;
      font-size: 11px;
    }

    .exchange-rate-badge .rate-item {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      color: #666;
    }

    .exchange-rate-badge .rate-value {
      font-weight: 600;
      color: #667eea;
    }

    .exchange-rate-badge .cache-warning {
      margin-top: 8px;
      padding: 6px 8px;
      background: #fff3cd;
      border-left: 3px solid #ffc107;
      border-radius: 4px;
      font-size: 10px;
      color: #856404;
      display: none;
    }

    .exchange-rate-badge .cache-warning.show {
      display: block;
    }

    @media (max-width: 600px) {
      .container {
        padding: 24px;
      }

      h1 {
        font-size: 24px;
      }

      .cycle-options {
        grid-template-columns: 1fr;
      }

      .exchange-rate-badge {
        top: 10px;
        right: 10px;
        font-size: 11px;
        padding: 10px 12px;
        min-width: 160px;
      }
    }
  </style>
</head>
<body>
  <!-- å³ä¸Šè§’æ±‡ç‡æ˜¾ç¤º -->
  <div id="exchangeRateBadge" class="exchange-rate-badge">
    <div class="title">ğŸ’± å®æ—¶æ±‡ç‡</div>
    <div id="rateContent" class="loading">è·å–ä¸­...</div>
    <div id="cacheWarning" class="cache-warning">
      âš ï¸ ä½¿ç”¨ç¼“å­˜æ•°æ®
    </div>
  </div>

  <div class="container">
    <h1>ğŸ’° VPS å‰©ä½™ä»·å€¼è®¡ç®—å™¨</h1>
    <p class="subtitle">è®¡ç®—æ‚¨çš„ VPS å½“å‰å‰©ä½™ä»·å€¼</p>

    <form id="calculatorForm">
      <div class="form-group">
        <label for="totalCost">è´­ä¹°ä»·æ ¼</label>
        <input type="number" id="totalCost" name="totalCost" step="0.01" min="0" required placeholder="ä¾‹å¦‚ï¼š365">
      </div>

      <div class="form-group">
        <label for="currency">è´§å¸å•ä½</label>
        <select id="currency" name="currency" required>
          <option value="CNY" selected>äººæ°‘å¸ (Â¥)</option>
          <option value="USD">ç¾å…ƒ ($)</option>
          <option value="EUR">æ¬§å…ƒ (â‚¬)</option>
          <option value="GBP">è‹±é•‘ (Â£)</option>
          <option value="JPY">æ—¥å…ƒ (Â¥)</option>
          <option value="KRW">éŸ©å…ƒ (â‚©)</option>
        </select>
      </div>

      <div class="form-group">
        <label for="purchaseDate">è´­ä¹°æ—¥æœŸ</label>
        <input type="date" id="purchaseDate" name="purchaseDate" required>
      </div>

      <div class="form-group">
        <label>ä»˜æ¬¾å‘¨æœŸ</label>
        <div class="cycle-options">
          <div class="cycle-option">
            <input type="radio" id="monthly" name="cycle" value="monthly" required>
            <label for="monthly">æœˆä»˜ï¼ˆ30å¤©ï¼‰</label>
          </div>
          <div class="cycle-option">
            <input type="radio" id="yearly" name="cycle" value="yearly" checked>
            <label for="yearly">å¹´ä»˜ï¼ˆ365å¤©ï¼‰</label>
          </div>
          <div class="cycle-option">
            <input type="radio" id="biennial" name="cycle" value="biennial">
            <label for="biennial">ä¸¤å¹´ä»˜ï¼ˆ730å¤©ï¼‰</label>
          </div>
          <div class="cycle-option">
            <input type="radio" id="triennial" name="cycle" value="triennial">
            <label for="triennial">ä¸‰å¹´ä»˜ï¼ˆ1095å¤©ï¼‰</label>
          </div>
        </div>
      </div>

      <button type="submit">ğŸ§® è®¡ç®—å‰©ä½™ä»·å€¼</button>
    </form>

    <div id="error" class="error"></div>

    <div id="result" class="result">
      <div class="result-item">
        <span class="result-label">å‰©ä½™ä»·å€¼</span>
        <span class="result-value highlight">Â¥<span id="remainingValue">0</span></span>
      </div>
      <div class="result-item" id="cnyEquivalent" style="display: none;">
        <span class="result-label">äººæ°‘å¸ç­‰å€¼</span>
        <span class="result-value" style="color: #667eea;">â‰ˆ Â¥<span id="cnyRemainingValue">0</span></span>
      </div>
      <div class="result-item">
        <span class="result-label">å·²ä½¿ç”¨ä»·å€¼</span>
        <span class="result-value">Â¥<span id="usedValue">0</span></span>
      </div>
      <div class="result-item">
        <span class="result-label">å‰©ä½™å¤©æ•°</span>
        <span class="result-value"><span id="remainingDays">0</span> å¤©</span>
      </div>
      <div class="result-item">
        <span class="result-label">å·²ä½¿ç”¨å¤©æ•°</span>
        <span class="result-value"><span id="usedDays">0</span> å¤©</span>
      </div>
      <div class="result-item">
        <span class="result-label">æ¯æ—¥æˆæœ¬</span>
        <span class="result-value">Â¥<span id="dailyRate">0</span></span>
      </div>
      <div class="result-item">
        <span class="result-label">ä½¿ç”¨è¿›åº¦</span>
        <div class="progress-bar">
          <div id="progressFill" class="progress-fill" style="width: 0%">0%</div>
        </div>
      </div>
    </div>

    <!-- è´§å¸è½¬æ¢åŒºåŸŸ -->
    <div id="currencyConverter" class="currency-converter">
      <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #333;">ğŸ’± è´§å¸è½¬æ¢</h3>
      <div class="currency-row">
        <select id="targetCurrency">
          <option value="CNY" selected>äººæ°‘å¸ (Â¥)</option>
          <option value="USD">ç¾å…ƒ ($)</option>
          <option value="EUR">æ¬§å…ƒ (â‚¬)</option>
          <option value="GBP">è‹±é•‘ (Â£)</option>
          <option value="JPY">æ—¥å…ƒ (Â¥)</option>
          <option value="KRW">éŸ©å…ƒ (â‚©)</option>
        </select>
        <div class="currency-value" id="convertedValue">--</div>
      </div>
      <p style="margin: 10px 0 0 0; font-size: 12px; color: #999;">å®æ—¶æ±‡ç‡è‡ªåŠ¨è®¡ç®—</p>
    </div>

    <!-- åˆ†äº«åŒºåŸŸ -->
    <div id="shareSection" class="share-section">
      <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #333;">ğŸ”— åˆ†äº«å¾½ç« </h3>

      <div class="form-group" style="margin-bottom: 15px;">
        <label for="sourceUrl" style="font-size: 13px; color: #666;">å‡ºå¤„ç½‘å€ï¼ˆæ˜¾ç¤ºåœ¨å¾½ç« åº•éƒ¨ï¼‰ï¼š</label>
        <input type="text" id="sourceUrl" value="localhost:3000" placeholder="ä¾‹å¦‚ï¼šyoursite.com" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;">
      </div>

      <div class="badge-preview">
        <img id="badgePreview" src="" alt="VPS å¾½ç« é¢„è§ˆ">
      </div>

      <div class="share-link">
        <label>å›¾ç‰‡é“¾æ¥ï¼ˆå¯åµŒå…¥ READMEï¼‰ï¼š</label>
        <input type="text" id="badgeUrl" readonly>
        <button class="copy-btn" id="copyBtn">ğŸ“‹ å¤åˆ¶é“¾æ¥</button>
      </div>

      <div class="share-link" style="margin-top: 15px;">
        <label>Markdown ä»£ç ï¼š</label>
        <input type="text" id="markdownCode" readonly>
        <button class="copy-btn" id="copyMarkdownBtn">ğŸ“‹ å¤åˆ¶ Markdown</button>
      </div>

      <button class="share-btn" id="shareBtn">ğŸ”„ ç”Ÿæˆåˆ†äº«é“¾æ¥</button>
    </div>
  </div>

  <script>
    // è·å–è¡¨å•å…ƒç´ 
    const form = document.getElementById('calculatorForm');
    const resultDiv = document.getElementById('result');
    const errorDiv = document.getElementById('error');
    const currencyConverterDiv = document.getElementById('currencyConverter');
    const shareSectionDiv = document.getElementById('shareSection');
    const exchangeRateBadgeDiv = document.getElementById('exchangeRateBadge');
    const rateContentDiv = document.getElementById('rateContent');

    // å…¨å±€å˜é‡å­˜å‚¨å½“å‰è®¡ç®—ç»“æœ
    let currentData = null;
    let currentCurrency = 'CNY';
    let convertedData = null; // å­˜å‚¨è½¬æ¢åçš„æ•°æ®ï¼ˆç”¨äº SVGï¼‰

    // è´§å¸ç¬¦å·æ˜ å°„
    const currencySymbols = {
      'CNY': 'Â¥',
      'USD': '$',
      'EUR': 'â‚¬',
      'GBP': 'Â£',
      'JPY': 'Â¥',
      'KRW': 'â‚©'
    };

    // é¡µé¢åŠ è½½æ—¶è·å–æ±‡ç‡
    async function fetchExchangeRates() {
      exchangeRateBadgeDiv.classList.add('show');
      rateContentDiv.innerHTML = '<div class="loading">è·å–ä¸­...</div>';

      try {
        // è·å–å››ç§è´§å¸åˆ° CNY çš„æ±‡ç‡ï¼šç¾å…ƒã€æ—¥å…ƒã€æ¬§å…ƒã€éŸ©å…ƒ
        const [usdResponse, jpyResponse, eurResponse, krwResponse] = await Promise.all([
          fetch('/api/exchange-rate?from=USD&to=CNY'),
          fetch('/api/exchange-rate?from=JPY&to=CNY'),
          fetch('/api/exchange-rate?from=EUR&to=CNY'),
          fetch('/api/exchange-rate?from=KRW&to=CNY')
        ]);

        const usdData = await usdResponse.json();
        const jpyData = await jpyResponse.json();
        const eurData = await eurResponse.json();
        const krwData = await krwResponse.json();

        if (usdData.success && jpyData.success && eurData.success && krwData.success) {
          // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•ä¸€ä¸ªä½¿ç”¨äº†é™çº§ç¼“å­˜
          const usingCache = usdData.data.fromCache || jpyData.data.fromCache ||
                             eurData.data.fromCache || krwData.data.fromCache;

          rateContentDiv.innerHTML = `
            <div class="rate-item">
              <span>ğŸ‡ºğŸ‡¸ USD</span>
              <span class="rate-value">Â¥${usdData.data.rate}</span>
            </div>
            <div class="rate-item">
              <span>ğŸ‡¯ğŸ‡µ JPY</span>
              <span class="rate-value">Â¥${jpyData.data.rate}</span>
            </div>
            <div class="rate-item">
              <span>ğŸ‡ªğŸ‡º EUR</span>
              <span class="rate-value">Â¥${eurData.data.rate}</span>
            </div>
            <div class="rate-item">
              <span>ğŸ‡°ğŸ‡· KRW</span>
              <span class="rate-value">Â¥${krwData.data.rate}</span>
            </div>
          `;

          // å¦‚æœä½¿ç”¨äº†é™çº§ç¼“å­˜ï¼Œæ˜¾ç¤ºè­¦å‘Š
          const cacheWarningDiv = document.getElementById('cacheWarning');
          if (usingCache) {
            cacheWarningDiv.classList.add('show');
          } else {
            cacheWarningDiv.classList.remove('show');
          }
        } else {
          throw new Error('è·å–æ±‡ç‡å¤±è´¥');
        }
      } catch (error) {
        rateContentDiv.innerHTML = '<div class="loading" style="color: #e05d44;">è·å–å¤±è´¥</div>';
        console.error('æ±‡ç‡è·å–é”™è¯¯:', error);
      }
    }

    // é¡µé¢åŠ è½½æ—¶è·å–æ±‡ç‡
    fetchExchangeRates();

    // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('purchaseDate').max = today;

    // è®¾ç½®é»˜è®¤å‡ºå¤„ç½‘å€ä¸ºå½“å‰åŸŸå
    document.getElementById('sourceUrl').value = window.location.host;

    // è¡¨å•æäº¤å¤„ç†
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // éšè—é”™è¯¯å’Œç»“æœ
      errorDiv.classList.remove('show');
      resultDiv.classList.remove('show');
      currencyConverterDiv.classList.remove('show');
      shareSectionDiv.classList.remove('show');

      // è·å–è¡¨å•æ•°æ®
      currentCurrency = document.getElementById('currency').value;
      const formData = {
        totalCost: parseFloat(document.getElementById('totalCost').value),
        cycle: document.querySelector('input[name="cycle"]:checked').value,
        purchaseDate: document.getElementById('purchaseDate').value
      };

      try {
        // è°ƒç”¨ API
        const response = await fetch('/api/calculate-by-cycle', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (!response.ok || !data.success) {
          throw new Error(data.error || 'è®¡ç®—å¤±è´¥');
        }

        // ä¿å­˜ç»“æœ
        currentData = data.data;
        currentData.currency = currentCurrency;

        // æ˜¾ç¤ºç»“æœ
        displayResult(currentData);

        // æ˜¾ç¤ºè´§å¸è½¬æ¢å’Œåˆ†äº«åŒºåŸŸ
        currencyConverterDiv.classList.add('show');
        shareSectionDiv.classList.add('show');

        // è‡ªåŠ¨è¿›è¡Œè´§å¸è½¬æ¢
        updateCurrencyConversion();

        // è‡ªåŠ¨ç”Ÿæˆåˆ†äº«é“¾æ¥
        generateShareLink();
      } catch (error) {
        showError(error.message);
      }
    });

    // æ˜¾ç¤ºç»“æœ
    async function displayResult(data) {
      const symbol = currencySymbols[currentCurrency];

      document.getElementById('remainingValue').textContent = data.remainingValue.toFixed(2);
      document.getElementById('usedValue').textContent = data.usedValue.toFixed(2);
      document.getElementById('remainingDays').textContent = data.remainingDays;
      document.getElementById('usedDays').textContent = data.usedDays;
      document.getElementById('dailyRate').textContent = data.dailyRate.toFixed(2);

      // æ›´æ–°è´§å¸ç¬¦å·æ˜¾ç¤º
      document.querySelectorAll('.result-value').forEach(el => {
        if (el.innerHTML.includes('Â¥') || el.innerHTML.includes('$') ||
            el.innerHTML.includes('â‚¬') || el.innerHTML.includes('Â£') || el.innerHTML.includes('â‚©')) {
          const value = el.querySelector('span');
          if (value && value.id !== 'cnyRemainingValue') {
            el.innerHTML = symbol + value.outerHTML;
          }
        }
      });

      // å¦‚æœé€‰æ‹©çš„è´§å¸ä¸æ˜¯äººæ°‘å¸ï¼Œè‡ªåŠ¨è®¡ç®—å¹¶æ˜¾ç¤ºäººæ°‘å¸ç­‰å€¼
      const cnyEquivalentDiv = document.getElementById('cnyEquivalent');
      if (currentCurrency !== 'CNY') {
        try {
          const response = await fetch(`/api/exchange-rate?from=${currentCurrency}&to=CNY`);
          const exchangeData = await response.json();

          if (exchangeData.success) {
            const cnyValue = data.remainingValue * exchangeData.data.rate;
            document.getElementById('cnyRemainingValue').textContent = cnyValue.toFixed(2);
            cnyEquivalentDiv.style.display = 'flex';
          } else {
            cnyEquivalentDiv.style.display = 'none';
          }
        } catch (error) {
          console.error('è·å–äººæ°‘å¸æ±‡ç‡å¤±è´¥:', error);
          cnyEquivalentDiv.style.display = 'none';
        }
      } else {
        cnyEquivalentDiv.style.display = 'none';
      }

      const progressFill = document.getElementById('progressFill');
      const usageRate = data.usageRate.toFixed(1);
      progressFill.style.width = usageRate + '%';
      progressFill.textContent = usageRate + '%';

      resultDiv.classList.add('show');
    }

    // è´§å¸è½¬æ¢
    async function updateCurrencyConversion() {
      if (!currentData) return;

      const targetCurrency = document.getElementById('targetCurrency').value;
      const convertedValueEl = document.getElementById('convertedValue');

      // å¦‚æœç›®æ ‡è´§å¸ä¸åŸè´§å¸ç›¸åŒ
      if (targetCurrency === currentCurrency) {
        const symbol = currencySymbols[targetCurrency];
        convertedValueEl.textContent = symbol + currentData.remainingValue.toFixed(2);

        // é‡ç½®ä¸ºåŸå§‹æ•°æ®
        convertedData = null;
        generateShareLink();
        return;
      }

      try {
        // è°ƒç”¨æ±‡ç‡ API
        const response = await fetch(`/api/exchange-rate?from=${currentCurrency}&to=${targetCurrency}`);
        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error);
        }

        // è®¡ç®—è½¬æ¢åçš„ä»·å€¼
        const convertedValue = currentData.remainingValue * data.data.rate;
        const convertedTotalCost = parseFloat(document.getElementById('totalCost').value) * data.data.rate;
        const symbol = currencySymbols[targetCurrency];
        convertedValueEl.textContent = symbol + convertedValue.toFixed(2);

        // ä¿å­˜è½¬æ¢åçš„æ•°æ®ç”¨äºç”Ÿæˆ SVG
        convertedData = {
          currency: targetCurrency,
          remainingValue: convertedValue,
          totalCost: convertedTotalCost,
          rate: data.data.rate
        };

        // è‡ªåŠ¨æ›´æ–° SVG
        generateShareLink();
      } catch (error) {
        convertedValueEl.textContent = 'è½¬æ¢å¤±è´¥';
        console.error('æ±‡ç‡è½¬æ¢é”™è¯¯:', error);
      }
    }

    // ç”Ÿæˆåˆ†äº«é“¾æ¥
    function generateShareLink() {
      if (!currentData) return;

      // ä½¿ç”¨è½¬æ¢åçš„æ•°æ®æˆ–åŸå§‹æ•°æ®
      const useCurrency = convertedData ? convertedData.currency : currentCurrency;
      const useRemainingValue = convertedData ? convertedData.remainingValue : currentData.remainingValue;
      const useTotalCost = convertedData ? convertedData.totalCost : parseFloat(document.getElementById('totalCost').value);

      // è®¡ç®—ç»“æŸæ—¥æœŸ
      const startDate = new Date(currentData.purchaseDate);
      const endDate = new Date(startDate);
      endDate.setDate(endDate.getDate() + currentData.totalDays);

      // è·å–å‡ºå¤„ç½‘å€
      const sourceUrl = document.getElementById('sourceUrl').value.trim();

      const params = new URLSearchParams({
        startDate: currentData.purchaseDate,
        endDate: endDate.toISOString().split('T')[0],
        currency: useCurrency,
        remainingValue: useRemainingValue.toFixed(2),
        totalCost: useTotalCost.toFixed(2),
        totalDays: currentData.totalDays
      });

      // å¦‚æœæœ‰å‡ºå¤„ç½‘å€ï¼Œæ·»åŠ åˆ°å‚æ•°ä¸­
      if (sourceUrl) {
        params.append('source', sourceUrl);
      }

      // ç”Ÿæˆå®Œæ•´ URL
      const baseUrl = window.location.origin;
      const badgeUrl = `${baseUrl}/api/badge.svg?${params.toString()}`;

      // æ›´æ–°é¢„è§ˆå›¾ç‰‡
      document.getElementById('badgePreview').src = badgeUrl;

      // æ›´æ–°é“¾æ¥
      document.getElementById('badgeUrl').value = badgeUrl;

      // æ›´æ–° Markdown ä»£ç 
      document.getElementById('markdownCode').value = `![VPS å‰©ä½™ä»·å€¼](${badgeUrl})`;
    }

    // ç›®æ ‡è´§å¸å˜åŒ–ç›‘å¬
    document.getElementById('targetCurrency').addEventListener('change', updateCurrencyConversion);

    // å‡ºå¤„ç½‘å€å˜åŒ–ç›‘å¬
    document.getElementById('sourceUrl').addEventListener('input', generateShareLink);

    // åˆ†äº«æŒ‰é’®ç‚¹å‡»
    document.getElementById('shareBtn').addEventListener('click', generateShareLink);

    // å¤åˆ¶æŒ‰é’®
    document.getElementById('copyBtn').addEventListener('click', async () => {
      const input = document.getElementById('badgeUrl');
      const btn = document.getElementById('copyBtn');

      try {
        await navigator.clipboard.writeText(input.value);
        btn.textContent = 'âœ… å·²å¤åˆ¶';
        btn.classList.add('copied');

        setTimeout(() => {
          btn.textContent = 'ğŸ“‹ å¤åˆ¶é“¾æ¥';
          btn.classList.remove('copied');
        }, 2000);
      } catch (error) {
        alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
      }
    });

    document.getElementById('copyMarkdownBtn').addEventListener('click', async () => {
      const input = document.getElementById('markdownCode');
      const btn = document.getElementById('copyMarkdownBtn');

      try {
        await navigator.clipboard.writeText(input.value);
        btn.textContent = 'âœ… å·²å¤åˆ¶';
        btn.classList.add('copied');

        setTimeout(() => {
          btn.textContent = 'ğŸ“‹ å¤åˆ¶ Markdown';
          btn.classList.remove('copied');
        }, 2000);
      } catch (error) {
        alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
      }
    });

    // æ˜¾ç¤ºé”™è¯¯
    function showError(message) {
      errorDiv.textContent = 'âŒ ' + message;
      errorDiv.classList.add('show');
    }

    // è¾“å…¥éªŒè¯
    document.getElementById('totalCost').addEventListener('input', (e) => {
      if (e.target.value < 0) {
        e.target.value = 0;
      }
    });

    document.getElementById('purchaseDate').addEventListener('change', (e) => {
      const selected = new Date(e.target.value);
      const now = new Date(today);

      if (selected > now) {
        showError('è´­ä¹°æ—¥æœŸä¸èƒ½æ™šäºå½“å‰æ—¥æœŸ');
        e.target.value = today;
      }
    });
  </script>
</body>
</html>
